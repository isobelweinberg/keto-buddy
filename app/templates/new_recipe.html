{% extends "base.html" %}
{% block content %}
<h2>Create New Recipe</h2>

<form method="POST" action="{{ url_for('main.new_recipe') }}">
    {{ form.hidden_tag() }}

    {% if form.errors %}
    <div class="alert alert-danger">
        <ul>
        {% for field, errors in form.errors.items() %}
            {% for error in errors %}
                <li>{{ field }}: {{ error }}</li>
            {% endfor %}
        {% endfor %}
        </ul>
    </div>
    {% endif %}

    <p>
        {{ form.name.label }}<br>
        {{ form.name(size=40) }}
    </p>

    <p>
        {{ form.notes.label }}<br>
        {{ form.notes(rows=4, cols=50) }}
    </p>

    <div class="form-group">
      {{ form.author.label }}<br>
      {{ form.author(class_="form-control", list="author-options") }}
      <datalist id="author-options">
        {% if existing_authors %}
          {% for author in existing_authors %}
            <option value="{{ author }}">
          {% endfor %}
        {% endif %}
      </datalist>
    </div>

    <div class="form-group">
      {{ form.meal_type.label }}<br>
      {{ form.meal_type(class_="form-control") }}
    </div>

    <h3>Ingredients</h3>
    <div id="ingredients-list">
        {% for subform in form.ingredients %}
        <div class="ingredient-entry">
            {{ subform.ingredient_id.label }} {{ subform.ingredient_id() }}
            {{ subform.amount.label }} {{ subform.amount(step="0.1", value=subform.amount.data or '0') }}
            <button type="submit" name="remove_ingredient" value="{{ loop.index0 }}">Remove</button>
        </div>
        {% endfor %}
    </div>
    <button type="submit" name="add_ingredient" value="1">Add Ingredient</button>

    <h3>Nutrition Summary</h3>
    <table border="1" id="nutrition-table">
        <thead>
            <tr>
                <th>Ingredient</th>
                <th>Amount</th>
                <th>Fat (g)</th>
                <th>Carbs (g)</th>
                <th>Protein (g)</th>
                <th>Calories</th>
            </tr>
        </thead>
        <tbody id="nutrition-tbody"></tbody>
        <tfoot>
            <tr>
                <td><strong>Totals</strong></td>
                <td id="total-amount">0</td>
                <td id="total-fat">0</td>
                <td id="total-carbs">0</td>
                <td id="total-protein">0</td>
                <td id="total-calories">0</td>
            </tr>
            <tr>
                <td colspan="5">
                    <strong>Ketogenic Ratio:</strong>
                    <span id="ketogenic-ratio">0</span>
                </td>
            </tr>
        </tfoot>
    </table>

    <p>{{ form.submit() }}</p>
</form>

<script>
    // Ingredient nutrition data passed from Flask (ingredient id -> nutrition)
    const nutritionData = {{ nutrition_data | tojson }};
    
    // Debug: Log nutrition data to console
    console.log('Nutrition Data:', nutritionData);

    function updateNutritionTable() {
        console.log('updateNutritionTable called');
        const tbody = document.getElementById('nutrition-tbody');
        tbody.innerHTML = '';

        let totalFat = 0, totalCarbs = 0, totalProtein = 0, totalCalories = 0;

        // Select all ingredient select and amount input fields rendered by WTForms
        const ingredientEntries = document.querySelectorAll('.ingredient-entry');
        console.log('Found ingredient entries:', ingredientEntries.length);
        
        ingredientEntries.forEach((entry, index) => {
            const select = entry.querySelector('select');
            const amountInput = entry.querySelector('input');

            const ingredientId = select ? select.value : null;
            const amountRaw = amountInput ? amountInput.value.trim() : '';
            const amount = amountRaw === '' ? 0 : parseFloat(amountRaw);

            console.log(`Entry ${index}: ingredientId=${ingredientId}, 
                amount=${amount}, amountRaw=${amountRaw}, amountInput=${amountInput}`);

            if (!ingredientId || ingredientId === '' || isNaN(amount) || amount <= 0) {
                console.log(`Skipping entry ${index}: invalid data`);
                return;
            }

            const data = nutritionData[String(ingredientId)];
            console.log(`Data for ingredient ${ingredientId}:`, data);
            
            if (!data) {
                console.log(`No nutrition data found for ingredient ${ingredientId}`);
                return;
            }

            const fat = data.percent_fat * amount / 100;
            const carbs = data.percent_carbs * amount / 100;
            const protein = data.percent_protein * amount / 100;
            const calories = data.total_calories * amount / 100;

            totalFat += fat;
            totalCarbs += carbs;
            totalProtein += protein;
            totalCalories += calories;

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${data.name}${data.source ? ' (' + data.source + ')' : ''}</td>
                <td>${amount} ${data.units}</td>
                <td>${fat.toFixed(2)}</td>
                <td>${carbs.toFixed(2)}</td>
                <td>${protein.toFixed(2)}</td>
                <td>${calories.toFixed(0)}</td>
            `;
            tbody.appendChild(row);
        });

        document.getElementById('total-fat').textContent = totalFat.toFixed(2);
        document.getElementById('total-carbs').textContent = totalCarbs.toFixed(2);
        document.getElementById('total-protein').textContent = totalProtein.toFixed(2);
        document.getElementById('total-calories').textContent = totalCalories.toFixed(2);

        // Calculate ketogenic ratio = fat / (carbs + protein)
        let ratio = 0;
        if (totalCarbs + totalProtein > 0) {
            ratio = totalFat / (totalCarbs + totalProtein);
        }
        document.getElementById('ketogenic-ratio').textContent = ratio.toFixed(2);
        
        console.log('Totals updated:', { totalFat, totalCarbs, totalProtein, totalCalories, ratio });
    }

    // Attach event listeners to all select and input fields on page load
    function attachNutritionListeners() {
        const ingredientEntries = document.querySelectorAll('.ingredient-entry');
        console.log('Attaching listeners to', ingredientEntries.length, 'entries');
        
        ingredientEntries.forEach((entry, index) => {
            const select = entry.querySelector('select');
            const amountInput = entry.querySelector('input');
            
            if (select) {
                select.addEventListener('change', updateNutritionTable);
                console.log(`Attached change listener to select ${index}`);
            }
            if (amountInput) {
                amountInput.addEventListener('input', updateNutritionTable);
                console.log(`Attached input listener to amount ${index}`);
            }
        });
    }

    // On page load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing nutrition table');
        attachNutritionListeners();
        updateNutritionTable();
    });
</script>

{% endblock %}
