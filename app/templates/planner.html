{% extends 'base.html' %}
{% block title %}Planner{% endblock %}

{% block content %}
<h1>10â€‘Day Planner</h1>
<form method="post">
  {{ form.csrf_token }}
  {% set idx = 0 %}
  {% for date, slot_names in slots_by_day %}
    <h2>{{ date.strftime('%A %d/%m/%Y') }}</h2>
    <table>
      <tr>
        <th>Meal</th>
        <th>Recipe</th>
        <th>Custom</th>
        <th>Ingredients</th>
      </tr>
      {% for slot in slot_names %}
        {% set fld = form['slot_' ~ idx] %}
        <tr>
          <td>{{ slot }}</td>

          <!-- Recipe dropdown -->
          <td>
            <select name="{{ fld.recipe_id.name }}" id="recipe_{{ idx }}" onchange="handleRecipeChange({{ idx }});">
              {% for val, label in fld.recipe_id.choices %}
                <option value="{{ val }}" {% if fld.recipe_id.data == val %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </td>

          <!-- Custom name input -->
          <td>
            <input type="text" name="{{ fld.free_text.name }}" id="custom_{{ idx }}" size="20"
                   value="{{ fld.free_text.data or '' }}"
                   style="display: {% if fld.recipe_id.data == -1 %}inline{% else %}none{% endif %};" />
          </td>

          <!-- Ingredients viewer -->
          <td>
            {% if fld.recipe_id.data and fld.recipe_id.data != 0 and fld.recipe_id.data != -1 %}
              {% set r = recipe_map[fld.recipe_id.data] %}
              <a href="#" onclick="toggleIngredients(this); return false;">View</a>
              <div class="ingredients" style="display:none;">
                <ul>
                  {% for ing in r.ingredients %}
                    <li>{{ ing.ingredient.name }}: {{ ing.amount }}{{ ing.ingredient.units }}</li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}
          </td>
        </tr>
        {% set idx = idx + 1 %}
      {% endfor %}
    </table>
  {% endfor %}

  {{ form.submit() }}
</form>

<script>
function toggleIngredients(a) {
  const div = a.nextElementSibling;
  div.style.display = (div.style.display === 'none' ? 'block' : 'none');
}

function handleRecipeChange(idx) {
  const dropdown = document.getElementById('recipe_' + idx);
  const customInput = document.getElementById('custom_' + idx);
  if (dropdown.value === '-1') {
    customInput.style.display = 'inline';
  } else {
    customInput.style.display = 'none';
  }
}
</script>
{% endblock %}
